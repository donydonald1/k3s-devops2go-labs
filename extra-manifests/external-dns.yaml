---
apiVersion: v1
kind: Namespace
metadata:
  name: external-dns

---
apiVersion: helm.cattle.io/v1
kind: HelmChart
metadata:
  name: external-dns
  namespace: external-dns
spec:
  chart: external-dns
  targetNamespace: external-dns
  repo: https://charts.bitnami.com/bitnami
  valuesContent: |-    
    global:
      imageRegistry: ""
      ## E.g.
      ## imagePullSecrets:
      ##   - myRegistryKeySecretName
      ##
      imagePullSecrets: []

    ## @section Common parameters
    ##

    ## @param clusterDomain Kubernetes Cluster Domain
    ##
    clusterDomain: cluster.local


    ## @param kubeVersion Force target Kubernetes version (using Helm capabilities if not set)
    ##
    kubeVersion: ""
    ## @param watchReleaseNamespace Watch only namepsace used for the release
    ##
    watchReleaseNamespace: false

    ## @section external-dns parameters
    ##

    ## Bitnami external-dns image version
    ## ref: https://hub.docker.com/r/bitnami/external-dns/tags/
    ## @param image.registry ExternalDNS image registry
    ## @param image.repository ExternalDNS image repository
    ## @param image.tag ExternalDNS Image tag (immutable tags are recommended)
    ## @param image.digest ExternalDNS image digest in the way sha256:aa.... Please note this parameter, if set, will override the tag
    ## @param image.pullPolicy ExternalDNS image pull policy
    ## @param image.pullSecrets ExternalDNS image pull secrets
    ##
    image:
      registry: docker.io
      repository: bitnami/external-dns
      tag: 0.13.1-debian-11-r19
      digest: ""
      ## Specify a imagePullPolicy
      ## Defaults to 'Always' if image tag is 'latest', else set to 'IfNotPresent'
      ## ref: https://kubernetes.io/docs/user-guide/images/#pre-pulling-images
      ##
      pullPolicy: IfNotPresent
      ## Optionally specify an array of imagePullSecrets.
      ## Secrets must be manually created in the namespace.
      ## ref: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/
      ## e.g:
      ## pullSecrets:
      ##   - myRegistryKeySecretName
      ##
      pullSecrets: []


    ## @param sources [array] K8s resources type to be observed for new DNS entries by ExternalDNS
    ##
    sources:
      # - crd
      - service
      - ingress
      # - contour-httpproxy

    provider: cloudflare
    ## @param initContainers Attach additional init containers to the pod (evaluated as a template)
    ##
    fqdnTemplates: []
    ## @param containerPorts.http HTTP Container port
    ##
    containerPorts:
      http: 7979
    ## @param combineFQDNAnnotation Combine FQDN template and annotations instead of overwriting
    ##
    combineFQDNAnnotation: false
    ## @param ignoreHostnameAnnotation Ignore hostname annotation when generating DNS names, valid only when fqdn-template is set
    ##
    ignoreHostnameAnnotation: false
    ## @param publishInternalServices Allow external-dns to publish DNS records for ClusterIP services
    ##
    publishInternalServices: false
    ## @param publishHostIP Allow external-dns to publish host-ip for headless services
    ##
    publishHostIP: false
    ## @param serviceTypeFilter The service types to take care about (default: all, options: ClusterIP, NodePort, LoadBalancer, ExternalName)
    ##

    cloudflare:
      ## @param cloudflare.apiToken When using the Cloudflare provider, `CF_API_TOKEN` to set (optional)
      ##
      apiToken: "${APITOKEN}"
      ## @param cloudflare.apiKey When using the Cloudflare provider, `CF_API_KEY` to set (optional)
      ##
      apiKey: "${APIKEY}"
      ## @param cloudflare.secretName When using the Cloudflare provider, it's the name of the secret containing cloudflare_api_token or cloudflare_api_key.
      ## This ignores cloudflare.apiToken, and cloudflare.apiKey
      ##
      secretName: ""
      ## @param cloudflare.email When using the Cloudflare provider, `CF_API_EMAIL` to set (optional). Needed when using CF_API_KEY
      ##
      email: "donydonald1@icloud.com"
      ## @param cloudflare.proxied When using the Cloudflare provider, enable the proxy feature (DDOS protection, CDN...) (optional)
      ##
      proxied: true
    ## CoreDNS configuration to be set via arguments/env variables
    ##
    coredns:
      ## @param coredns.etcdEndpoints When using the CoreDNS provider, set etcd backend endpoints (comma-separated list)
      ## Secure (https) endpoints can be used as well, in that case `etcdTLS` section
      ## should be filled in accordingly
      ##
      etcdEndpoints: "http://etcd-extdns:2379"
      ## Configuration of the secure communication and client authentication to the etcd cluster
      ## If enabled all the values under this key must hold a valid data
      ##
      etcdTLS:
        ## @param coredns.etcdTLS.enabled When using the CoreDNS provider, enable secure communication with etcd
        ##
        enabled: false
        ## @param coredns.etcdTLS.autoGenerated Generate automatically self-signed TLS certificates
        ##
        autoGenerated: false
        ## @param coredns.etcdTLS.secretName When using the CoreDNS provider, specify a name of existing Secret with etcd certs and keys
        ## ref: https://github.com/etcd-io/etcd/blob/master/Documentation/op-guide/security.md
        ## ref (secret creation):
        ##  https://github.com/bitnami/charts/tree/main/bitnami/etcd#configure-certificates-for-client-communication
        ##
        secretName: "etcd-client-certs"
        ## @param coredns.etcdTLS.mountPath When using the CoreDNS provider, set destination dir to mount data from `coredns.etcdTLS.secretName` to
        ##
        mountPath: "/etc/coredns/tls/etcd"
        ## @param coredns.etcdTLS.caFilename When using the CoreDNS provider, specify CA PEM file name from the `coredns.etcdTLS.secretName`
        ##
        caFilename: "ca.crt"
        ## @param coredns.etcdTLS.certFilename When using the CoreDNS provider, specify cert PEM file name from the `coredns.etcdTLS.secretName`
        ## Will be used by external-dns to authenticate against etcd
        ##
        certFilename: "cert.pem"
        ## @param coredns.etcdTLS.keyFilename When using the CoreDNS provider, specify private key PEM file name from the `coredns.etcdTLS.secretName`
        ## Will be used by external-dns to authenticate against etcd
        ##
        keyFilename: "key.pem"
    ## OpenStack Designate provider configuration to be set via arguments/env. variables
    ##

    ## @param domainFilters Limit possible target zones by domain suffixes (optional)
    ##
    domainFilters: []
    ## @param excludeDomains Exclude subdomains (optional)
    ##
    excludeDomains: []
    ## @param regexDomainFilter Limit possible target zones by regex domain suffixes (optional)
    ## If regexDomainFilter is specified, domainFilters will be ignored
    ##
    regexDomainFilter: ""
    ## @param regexDomainExclusion Exclude subdomains by using regex pattern (optional)
    ## If regexDomainFilter is specified, excludeDomains will be ignored and external-dns will use regexDomainExclusion even though regexDomainExclusion is empty
    ##
    regexDomainExclusion: ""
    ## @param zoneNameFilters Filter target zones by zone domain (optional)
    ##
    zoneNameFilters: []
    ## @param zoneIdFilters Limit possible target zones by zone id (optional)
    ##
    zoneIdFilters: []
    ## @param annotationFilter Filter sources managed by external-dns via annotation using label selector (optional)
    ##
    annotationFilter: ""
    ## @param labelFilter Select sources managed by external-dns using label selector (optional)
    ##
    labelFilter: ""
    ## @param dryRun When enabled, prints DNS record changes rather than actually performing them (optional)
    ##
    dryRun: false
    ## @param triggerLoopOnEvent When enabled, triggers run loop on create/update/delete events in addition to regular interval (optional)
    ##
    triggerLoopOnEvent: false
    ## @param interval Interval update period to use
    ##
    interval: "1m"
    ## @param logLevel Verbosity of the logs (options: panic, debug, info, warning, error, fatal, trace)
    ##
    logLevel: info
    ## @param logFormat Which format to output logs in (options: text, json)
    ##
    logFormat: text
    ## @param policy Modify how DNS records are synchronized between sources and providers (options: sync, upsert-only )
    ##
    policy: upsert-only
    ## @param registry Registry method to use (options: txt, aws-sd, noop)
    ## ref: https://github.com/kubernetes-sigs/external-dns/blob/master/docs/proposal/registry.md
    ##
    registry: "txt"
    ## @param txtPrefix When using the TXT registry, a prefix for ownership records that avoids collision with CNAME entries (optional)<CNAME record> (Mutual exclusive with txt-suffix)
    ##
    txtPrefix: ""
    ## @param txtSuffix When using the TXT registry, a suffix for ownership records that avoids collision with CNAME entries (optional)<CNAME record>.suffix (Mutual exclusive with txt-prefix)
    ##
    txtSuffix: ""
    ## @param txtOwnerId A name that identifies this instance of ExternalDNS. Currently used by registry types: txt & aws-sd (optional)
    ## But other registry types might be added in the future.
    ##
    txtOwnerId: ""
    forceTxtOwnerId: false
    ## @param extraArgs Extra arguments to be passed to external-dns
    ##
    extraArgs: {}
    ## @param extraEnvVars An array to add extra env vars
    ##
    extraEnvVars: []
    ## @param extraEnvVarsCM ConfigMap containing extra env vars
    ##
    extraEnvVarsCM: ""
    ## @param extraEnvVarsSecret Secret containing extra env vars (in case of sensitive data)
    ##
    extraEnvVarsSecret: ""
    ## @param lifecycleHooks [object] Override default etcd container hooks
    ##
    lifecycleHooks: {}
    ## @param schedulerName Alternative scheduler
    ## ref: https://kubernetes.io/docs/tasks/administer-cluster/configure-multiple-schedulers/
    ##
    schedulerName: ""
    ## @param topologySpreadConstraints Topology Spread Constraints for pod assignment
    ## https://kubernetes.io/docs/concepts/workloads/pods/pod-topology-spread-constraints/
    ## The value is evaluated as a template
    ##
    topologySpreadConstraints: []
    ## @param replicaCount Desired number of ExternalDNS replicas
    ##
    replicaCount: 3
    ## @param podAffinityPreset Pod affinity preset. Ignored if `affinity` is set. Allowed values: `soft` or `hard`
    ## ref: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity
    ##
    podAffinityPreset: ""
    ## @param podAntiAffinityPreset Pod anti-affinity preset. Ignored if `affinity` is set. Allowed values: `soft` or `hard`
    ## Ref: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#inter-pod-affinity-and-anti-affinity
    ## Allowed values: soft, hard
    ##
    podAntiAffinityPreset: soft
    ## Node affinity preset
    ## Ref: https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/#node-affinity
    ##
    nodeAffinityPreset:
      ## @param nodeAffinityPreset.type Node affinity preset type. Ignored if `affinity` is set. Allowed values: `soft` or `hard`
      ##
      type: ""
      ## @param nodeAffinityPreset.key Node label key to match Ignored if `affinity` is set.
      ## E.g.
      ## key: "kubernetes.io/e2e-az-name"
      ##
      key: ""
      ## @param nodeAffinityPreset.values Node label values to match. Ignored if `affinity` is set.
      ## E.g.
      ## values:
      ##   - e2e-az1
      ##   - e2e-az2
      ##
      values: []
    ## @param affinity Affinity for pod assignment
    ## Ref: https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity
    ## Note: podAffinityPreset, podAntiAffinityPreset, and  nodeAffinityPreset will be ignored when it's set
    ##
    affinity: {}
    ## @param nodeSelector Node labels for pod assignment
    ## Ref: https://kubernetes.io/docs/user-guide/node-selection/
    ##
    nodeSelector: {}
    ## @param tolerations Tolerations for pod assignment
    ## Ref: https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/
    ##
    tolerations: []
    ## @param podAnnotations Additional annotations to apply to the pod.
    ##
    podAnnotations: {}
    ## @param podLabels Additional labels to be added to pods
    ##
    podLabels: {}
    ## @param priorityClassName priorityClassName
    ##
    priorityClassName: ""
    ## @param secretAnnotations Additional annotations to apply to the secret
    ##
    secretAnnotations: {}
    ## Options for the source type "crd"
    ##
    crd:
      ## @param crd.create Install and use the integrated DNSEndpoint CRD
      ##
      create: false
      ## @param crd.apiversion Sets the API version for the CRD to watch
      ##
      apiversion: ""
      ## @param crd.kind Sets the kind for the CRD to watch
      ##
      kind: ""
    ## Kubernetes svc configutarion
    ##
    service:
      ## @param service.enabled Whether to create Service resource or not
      ##
      enabled: true
      ## @param service.type Kubernetes Service type
      ##
      type: ClusterIP
      ## @param service.ports.http ExternalDNS client port
      ##
      ports:
        http: 7979
      ## @param service.nodePorts.http Port to bind to for NodePort service type (client port)
      ## ref: https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport
      ##
      nodePorts:
        http: ""
      ## @param service.clusterIP IP address to assign to service
      ##
      clusterIP: ""
      ## @param service.externalIPs Service external IP addresses
      ##
      externalIPs: []
      ## @param service.loadBalancerIP IP address to assign to load balancer (if supported)
      ##
      loadBalancerIP: ""
      ## @param service.loadBalancerSourceRanges List of IP CIDRs allowed access to load balancer (if supported)
      ##
      loadBalancerSourceRanges: []
      ## @param service.externalTrafficPolicy Enable client source IP preservation
      ## ref http://kubernetes.io/docs/tasks/access-application-cluster/create-external-load-balancer/#preserving-the-client-source-ip
      ##
      externalTrafficPolicy: Cluster
      ## @param service.extraPorts Extra ports to expose in the service (normally used with the `sidecar` value)
      ##
      extraPorts: []
      annotations: {}
      labels: {}
      sessionAffinity: None
      sessionAffinityConfig: {}
    ## ServiceAccount parameters
    ## https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/
    ##
    serviceAccount:
      ## @param serviceAccount.create Determine whether a Service Account should be created or it should reuse a exiting one.
      ##
      create: true
      ## @param serviceAccount.name ServiceAccount to use. A name is generated using the external-dns.fullname template if it is not set
      ##
      name: ""
      ## @param serviceAccount.annotations Additional Service Account annotations
      ##
      annotations: {}
      ## @param serviceAccount.automountServiceAccountToken Automount API credentials for a service account.
      ##
      automountServiceAccountToken: true
      ## @param serviceAccount.labels [object] Additional labels to be included on the service account
      ##
      labels: {}
    ## RBAC parameters
    ## https://kubernetes.io/docs/reference/access-authn-authz/rbac/
    ##
    rbac:
      ## @param rbac.create Whether to create & use RBAC resources or not
      ##
      create: true
      ## @param rbac.clusterRole Whether to create Cluster Role. When set to false creates a Role in `namespace`
      ##
      clusterRole: true
      ## @param rbac.apiVersion Version of the RBAC API
      ##
      apiVersion: v1
      ## @param rbac.pspEnabled Whether to create a PodSecurityPolicy. WARNING: PodSecurityPolicy is deprecated in Kubernetes v1.21 or later, unavailable in v1.25 or later
      ##
      pspEnabled: false
    containerSecurityContext: {}
    podSecurityContext:
      enabled: true
      fsGroup: 1001
      runAsUser: 1001
    resources:
      limits: {}
      requests: {}
    livenessProbe:
      enabled: true
      initialDelaySeconds: 10
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 2
      successThreshold: 1
    readinessProbe:
      enabled: true
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 6
      successThreshold: 1
    startupProbe:
      enabled: false
      initialDelaySeconds: 5
      periodSeconds: 10
      timeoutSeconds: 5
      failureThreshold: 6
      successThreshold: 1
    ## @param customLivenessProbe Override default liveness probe
    ##
    customLivenessProbe: {}
    ## @param customReadinessProbe Override default readiness probe
    ##
    customReadinessProbe: {}
    ## @param customStartupProbe Override default startup probe
    ##
    customStartupProbe: {}
    ## @param extraVolumes A list of volumes to be added to the pod
    ##
    extraVolumes: []
    ## @param extraVolumeMounts A list of volume mounts to be added to the pod
    ##
    extraVolumeMounts: []
    ## @param podDisruptionBudget Configure PodDisruptionBudget
    ## ref: https://kubernetes.io/docs/tasks/run-application/configure-pdb/
    ##

    podDisruptionBudget: {}
    ## Prometheus Exporter / Metrics
    ##
    metrics:
      ## @param metrics.enabled Enable prometheus to access external-dns metrics endpoint
      ##
      enabled: true
      ## @param metrics.podAnnotations Annotations for enabling prometheus to access the metrics endpoint
      ##
      podAnnotations: {}
      ## Prometheus Operator ServiceMonitor configuration
      ##
      serviceMonitor:
        ## @param metrics.serviceMonitor.enabled Create ServiceMonitor object
        ##
        enabled: false
        ## @param metrics.serviceMonitor.namespace Namespace in which Prometheus is running
        ##
        namespace: ""
        ## @param metrics.serviceMonitor.interval Interval at which metrics should be scraped
        ## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#endpoint
        ##
        interval: ""
        ## @param metrics.serviceMonitor.scrapeTimeout Timeout after which the scrape is ended
        ## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#endpoint
        ##
        scrapeTimeout: ""
        ## @param metrics.serviceMonitor.selector Additional labels for ServiceMonitor object
        ## ref: https://github.com/bitnami/charts/tree/main/bitnami/prometheus-operator#prometheus-configuration
        ## e.g:
        ## selector:
        ##   prometheus: my-prometheus
        ##
        selector: {}
        ## @param metrics.serviceMonitor.metricRelabelings Specify Metric Relabelings to add to the scrape endpoint
        ## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#relabelconfig
        ##
        metricRelabelings: []
        ## @param metrics.serviceMonitor.relabelings [array] Prometheus relabeling rules
        ##
        relabelings: []
        ## @param metrics.serviceMonitor.honorLabels Specify honorLabels parameter to add the scrape endpoint
        ##
        honorLabels: false
        ## DEPRECATED metrics.serviceMonitor.additionalLabels will be removed in a future release - Please use metrics.serviceMonitor.labels instead
        ## @param metrics.serviceMonitor.labels Used to pass Labels that are required by the installed Prometheus Operator
        ## ref: https://github.com/coreos/prometheus-operator/blob/master/Documentation/api.md#prometheusspec
        ##
        labels: {}
        ## @param metrics.serviceMonitor.jobLabel The name of the label on the target service to use as the job name in prometheus.
        ##
        jobLabel: ""
      ## Google Managed Prometheus PodMonitor configuration
      ##
      googlePodMonitor:
        ## @param metrics.googlePodMonitor.enabled Create Google Managed Prometheus PodMonitoring object
        ##
        enabled: false
        ## @param metrics.googlePodMonitor.namespace Namespace in which PodMonitoring created
        ##
        namespace: ""
        ## @param metrics.googlePodMonitor.interval Interval at which metrics should be scraped by Google Managed Prometheus
        ##
        interval: "60s"
        ## @param  metrics.googlePodMonitor.endpoint The endpoint for Google Managed Prometheus scraping the metrics
        ##
        endpoint: /metrics